<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>file</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/layui/2.7.6/css/layui.css" integrity="sha512-SSF+OBDODWTSIqOivYBOyOKQ93PBDevipJEUEWtkUbTt4v34rmgPcCXcBMolxZIJcuobcdqmYJlonjUBEbOzNw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/layui/2.7.6/layui.js" integrity="sha512-mIKH3M2bRlIyhG4tBEbJ8dn8t8JFlNJU2NXlJePgpQ72CK4jAYsZyCGFcASRGtPBbcAQhz67KTkA1Jw6Kizk9g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe" crossorigin="anonymous"></script>
</head>
<body>

<script type="text/html" id="toolEvent">

    {{#  if(d.type === 'FOLDER'){ }}
    <button type="button" class="btn btn-primary" lay-event="in">In</button>
    {{#  } }}
    {{#  if(d.type !== 'FOLDER'){ }}
    <button type="button" class="btn btn-primary" lay-event="download">Download</button>
    {{#  } }}
</script>

<div style="text-align: center">
    <h1>Welcome To Cloud Disk</h1>
</div>
<div style="margin-left: 80%;height: 40px;text-align: right">
    <!-- Button trigger modal -->
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#uploadModal">
        Upload file
    </button>
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createFolderModal">
        Create Folder
    </button>
</div>

<!-- 文件表格 -->
<div>
    <table id="fileList" lay-filter="fileList"></table>
</div>


<!-- Uploda File Modal -->
<div class="modal fade" id="uploadModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="exampleModalLabel">Upload file</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <form action="/file/upload" method="post" enctype="multipart/form-data" id="uploadFileForm">
                        <div style="display: none">
                            <label for="pid" class="form-label"></label>
                            <input class="form-control" type="text" id="pid" name="pid">
                        </div>
                        <label for="file" class="form-label">Select file</label>
                        <input class="form-control" type="file" id="file" name="file">
                    </form>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="upload()">Upload</button>
            </div>
        </div>
    </div>
</div>

<!-- Create Folder Modal -->
<div class="modal fade" id="createFolderModal" tabindex="-1" aria-labelledby="createFolderModalLabel"
     aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="createFolderModalLabel">Create Folder</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="filename" class="form-label">Folder name</label>
                    <input class="form-control" type="text" id="filename"/>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="createFolder()">Create</button>
            </div>
        </div>
    </div>
</div>
</body>
<script src="https://unpkg.com/axios@1.1.2/dist/axios.min.js">
    import axios from 'axios';
</script>
<script>

    var pid = -1;

    function upload() {
        document.getElementById('pid').value = pid;
        document.getElementById('uploadFileForm').submit();
    }

    function createFolder() {
        axios.post('/file/folder', {
            pid: pid,
            filename: document.getElementById('filename').value
        }).then(function (res) {
            if (res.data.code === "0") {
                alert("Create folder success.")
            } else {
                alert(res.data.msg);
            }
        }).catch(function (err) {

        })
    }

    /**
     * 加载表格数据
     */
    layui.use('table', function () {
        var table = layui.table;

        //第一个实例
        table.render({
            elem: '#fileList'
            // , height: 312
            , url: '/file/pageList' //数据接口
            , page: true
            ,where: {
                pid: pid
            },
            request: {
                pageName: 'pageNum',
                limitName: 'pageSize'
            },
            parseData: function (res) {
                return {
                    "code": res.code,
                    "msg": res.msg,
                    "count": res.data.total,
                    "data": res.data.records
                }
            }//开启分页
            , cols: [[ //表头
                {field: 'id', title: 'ID', width: 80, sort: true, fixed: 'left'}
                , {field: 'filename', title: 'filename', width: 270}
                , {field: 'size', title: 'size', width: 80}
                , {field: 'uploadTime', title: 'upload time', width: 270}
                , {field: 'type', title: 'type', width: 100}
                , {title: 'operation', width: 200, templet: '#toolEvent'}
            ]]
        });

        table.on('tool(fileList)', function (obj) {
            var data = obj.data;
            var layEvent = obj.event;
            var tr = obj.tr; //dom
            if (layEvent === 'download') {
                location.href = '/file/download?fileId=' + data.id;
            }else if(layEvent === 'in'){
                // 重载数据
                table.reload('fileList', {
                    where: { //设定异步数据接口的额外参数，任意设
                        pid: data.id,
                    }
                    ,page: {
                        curr: 1 //重新从第 1 页开始
                    }
                });
                pid = data.id;
            }
        })
    });
</script>
</html>